/* Autogenerated with kurento-module-creator */

#include <gst/gst.h>
#include "BaseRtpEndpointImpl.hpp"
#include <jsonrpc/JsonSerializer.hpp>
#include <KurentoException.hpp>
#include <MediaState.hpp>
#include <time.h>
#include <SignalHandler.hpp>

#include "Statistics.hpp"

#define GST_CAT_DEFAULT kurento_base_rtp_endpoint_impl
GST_DEBUG_CATEGORY_STATIC (GST_CAT_DEFAULT);
#define GST_DEFAULT_NAME "KurentoBaseRtpEndpointImpl"

#define KMS_MEDIA_DISCONNECTED 0
#define KMS_MEDIA_CONNECTED 1

namespace kurento
{
void BaseRtpEndpointImpl::postConstructor ()
{
  SdpEndpointImpl::postConstructor ();

  stateChangedHandlerId = register_signal_handler (G_OBJECT (element),
                          "media-state-changed",
                          std::function <void (GstElement *, guint) > (std::bind (
                                &BaseRtpEndpointImpl::updateState, this,
                                std::placeholders::_2) ),
                          std::dynamic_pointer_cast<BaseRtpEndpointImpl>
                          (shared_from_this() ) );
}

BaseRtpEndpointImpl::BaseRtpEndpointImpl (const boost::property_tree::ptree
    &config,
    std::shared_ptr< MediaObjectImpl > parent,
    const std::string &factoryName) :
  SdpEndpointImpl (config, parent, factoryName)
{

  current_state = std::make_shared <MediaState>
                  (MediaState::DISCONNECTED);
}

BaseRtpEndpointImpl::~BaseRtpEndpointImpl ()
{
  unregister_signal_handler (element, stateChangedHandlerId);
}

void
BaseRtpEndpointImpl::updateState (guint new_state)
{
  std::shared_ptr<MediaState> old_state;

  old_state = current_state;

  switch (new_state) {
  case KMS_MEDIA_DISCONNECTED:
    current_state = std::make_shared <MediaState>
                    (MediaState::DISCONNECTED);
    break;

  case KMS_MEDIA_CONNECTED:
    current_state = std::make_shared <MediaState>
                    (MediaState::CONNECTED);
    break;

  default:
    GST_ERROR ("Invalid media state %u", new_state);
    return;
  }

  MediaStateChanged event (shared_from_this(),
                           MediaStateChanged::getName (), old_state, current_state);

  this->signalMediaStateChanged (event);
}

int BaseRtpEndpointImpl::getMinVideoSendBandwidth ()
{
  int minVideoSendBandwidth;

  g_object_get (element, "min-video-send-bandwidth", &minVideoSendBandwidth,
                NULL);

  return minVideoSendBandwidth;
}

void BaseRtpEndpointImpl::setMinVideoSendBandwidth (int minVideoSendBandwidth)
{
  g_object_set (element, "min-video-send-bandwidth", minVideoSendBandwidth, NULL);
}

int BaseRtpEndpointImpl::getMaxVideoSendBandwidth ()
{
  int maxVideoSendBandwidth;

  g_object_get (element, "max-video-send-bandwidth", &maxVideoSendBandwidth,
                NULL);

  return maxVideoSendBandwidth;
}

void BaseRtpEndpointImpl::setMaxVideoSendBandwidth (int maxVideoSendBandwidth)
{
  g_object_set (element, "max-video-send-bandwidth", maxVideoSendBandwidth, NULL);
}

std::map <std::string, std::shared_ptr<RTCStats>>
    BaseRtpEndpointImpl::getStats ()
{
  std::map <std::string, std::shared_ptr<RTCStats>> rtcStatsReport;
  GstStructure *stats;

  g_object_get (getGstreamerElement(), "stats", &stats, NULL);

  rtcStatsReport = stats::createRTCStatsReport (time (NULL), stats);

  gst_structure_free (stats);

  return rtcStatsReport;
}

std::shared_ptr<MediaState>
BaseRtpEndpointImpl::getMediaState ()
{
  return current_state;
}

BaseRtpEndpointImpl::StaticConstructor BaseRtpEndpointImpl::staticConstructor;

BaseRtpEndpointImpl::StaticConstructor::StaticConstructor()
{
  GST_DEBUG_CATEGORY_INIT (GST_CAT_DEFAULT, GST_DEFAULT_NAME, 0,
                           GST_DEFAULT_NAME);
}

} /* kurento */
